name: Miatoll HyperOS 3 Auto-Porter

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'HyperOS / MIUI firmware zip'
        required: true
        type: string
      android_version:
        description: 'Android Version (14/15)'
        required: true
        default: '14'
        type: string
      output_format:
        description: 'Output Format'
        required: true
        type: choice
        options: [recovery_zip, raw_images]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            git wget curl unzip zip p7zip-full \
            python3 python3-pip \
            openjdk-17-jdk \
            e2fsprogs erofs-utils \
            liblz4-tool brotli \
            build-essential zlib1g-dev

          pip3 install --upgrade pip protobuf

      - name: Setup tools
        run: |
          mkdir -p tools
          cd tools

          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -xzf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          chmod +x payload-dumper-go

          git clone https://github.com/anestisb/android-simg2img
          cd android-simg2img
          make
          sudo cp simg2img img2simg /usr/local/bin/
          cd ..

      - name: Download HyperOS firmware
        run: |
          mkdir -p build/input build/output
          cd build/input
          wget "${{ inputs.source_url }}" -O rom.zip
          7z l rom.zip > list.txt
          mkdir raw_images

          unzip rom.zip payload.bin
          ../../tools/payload-dumper-go -o raw_images \
            -p system,system_ext,product,vendor,odm payload.bin

          cd raw_images
          for i in *.img; do
            file "$i" | grep -qi sparse && simg2img "$i" tmp && mv tmp "$i"
          done

      - name: Mount partitions
        working-directory: build
        run: |
          set -e
          mkdir -p port/{system,system_ext,product,vendor,odm,src}

          mount_img() {
            P=$1
            IMG=input/raw_images/$P.img
            MNT=port/$P
            SRC=port/src

            FS=$(file -bL "$IMG")
            if echo "$FS" | grep -qi erofs; then
              SIZE=$(stat -c%s "$IMG")
              dd if=/dev/zero of=$P.ext4 bs=1 count=0 seek=$((SIZE*4))
              mkfs.ext4 -F -L $P -I 256 $P.ext4
              sudo mount -o loop,ro "$IMG" "$SRC"
              sudo mount -o loop,rw "$P.ext4" "$MNT"
              cd "$SRC"
              sudo find . \( -type f -o -type l -o -type d \) -print0 | \
                sudo xargs -0 -r cp -a --parents -t "$MNT"
              cd -
              sudo umount "$SRC"
              sudo umount "$MNT"
              mv $P.ext4 "$IMG"
            fi
            sudo mount -o loop,rw "$IMG" "$MNT"
          }

          for p in system system_ext product vendor odm; do
            mount_img $p
          done

      - name: VNDK compatibility hacks (HyperOS)
        working-directory: build
        run: |
          set -e
          VENDOR=port/vendor

          # Detect VNDK
          VNDK_VER=$(grep -R "ro.vndk.version" $VENDOR/build.prop | cut -d= -f2 | head -n1)
          [ -z "$VNDK_VER" ] && VNDK_VER=33

          mkdir -p port/system_ext/lib64/vndk-sp-$VNDK_VER
          ln -sf /vendor/lib64/libc.so port/system_ext/lib64/vndk-sp-$VNDK_VER/libc.so

          # Disable strict checks
          sed -i 's/ro.vndk.lite=true/ro.vndk.lite=false/' \
            port/vendor/build.prop || true

      - name: Vendor blobs alignment (MIUI / HyperOS)
        working-directory: build
        run: |
          set -e
          V=port/vendor

          # Common MIUI blobs expected by AOSP
          for lib in libwfdservice.so libqti-perfd-client.so libimsmedia.so; do
            if [ -f "$V/lib64/$lib" ]; then
              ln -sf /vendor/lib64/$lib port/system_ext/lib64/$lib
            fi
          done

          # Move MIUI-only libs out of system path
          find port/system -name "*miui*" -type f -exec mv {} $V/lib64/ \; || true

      - name: SEPolicy fixups (HyperOS)
        working-directory: build
        run: |
          set -e
          VENDOR=port/vendor

          # Permissive vendor domains
          for dom in miui_daemon ims ril thermal hal_audio_default; do
            echo "(permissive $dom)" >> $VENDOR/etc/selinux/vendor_sepolicy.cil
          done

          # Allow common vendor HALs
          cat >> $VENDOR/etc/selinux/vendor_sepolicy.cil <<EOF
          (allow hal_audio_default vendor_file (file (read write open)))
          (allow ims vendor_socket (sock_file (write)))
          EOF

      - name: Finalize images
        working-directory: build
        run: |
          set -e
          OUT=output
          mkdir -p $OUT

          for p in system system_ext product vendor odm; do
            IMG=input/raw_images/$p.img
            MNT=port/$p
            sudo umount "$MNT" || true
            sudo e2fsck -f -y "$IMG" || true
            sudo resize2fs -M "$IMG"
            img2simg "$IMG" "$OUT/$p.img"
          done

      - name: Package
        working-directory: build/output
        run: |
          if [ "${{ inputs.output_format }}" = "recovery_zip" ]; then
            zip -r miatoll_hyperos3_port.zip *.img
            rm *.img
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: miatoll_hyperos3_port
          path: build/output/*
