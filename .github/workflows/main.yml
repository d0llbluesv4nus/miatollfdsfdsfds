name: Miatoll Auto-Porter (SM6250)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'Direct URL to Source ROM (Fastboot/Recovery Zip/Payload)'
        required: true
        type: string
      rom_type:
        description: 'Source ROM Type'
        required: true
        type: choice
        options:
          - AOSP
          - MIUI
          - OneUI
          - OxygenOS
          - ColorOS
          - Other
      android_version:
        description: 'Android Version'
        required: true
        default: '13'
        type: string
      device_tree_url:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/LineageOS/android_device_xiaomi_miatoll'
        type: string
      vendor_tree_url:
        description: 'Vendor Tree URL'
        required: true
        default: 'https://github.com/clarencelol/vendor_xiaomi_miatoll'
        type: string
      kernel_tree_url:
        description: 'Kernel Tree URL'
        required: true
        default: 'https://github.com/LineageOS/android_kernel_xiaomi_sm6250'
        type: string
      target_variant:
        description: 'Target Region'
        required: true
        type: choice
        options:
          - global
          - india
          - china
      output_format:
        description: 'Output Format'
        required: true
        type: choice
        options:
          - recovery_zip
          - super_img

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: 1. Environment Cleanup (Aggressive)
        id: cleanup
        run: |
          set -e
          echo "::group::Cleaning Disk Space"
          df -h
          
          # Remove massive pre-installed packages
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/lib/google-cloud-sdk
          sudo rm -rf /usr/lib/jvm
          
          # Clean Docker and APT
          sudo docker system prune -a -f
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo rm -rf /var/lib/apt/lists/*
          
          # Check space (Threshold 30GB)
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Free Space: ${AVAILABLE}GB"
          if [ "$AVAILABLE" -lt 30 ]; then
            echo "::error::Not enough disk space (<30GB). Setup failed."
            exit 1
          fi
          
          # Setup Swap (12GB) - Critical
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "::endgroup::"

      - name: 2. Install Tools & Dependencies
        run: |
          set -e
          echo "::group::Installing Packages"
          sudo apt-get update
          
          # Install deps including zlib for compiling simg2img and erofs-utils
          sudo apt-get install -y \
            git wget curl python3 python3-pip zip unzip tar 7zip \
            brotli lz4 openjdk-17-jdk \
            liblz4-tool e2fsprogs device-tree-compiler build-essential zlib1g-dev \
            erofs-utils rsync
          
          # Install Python protobuf
          pip3 install --upgrade pip protobuf
          
          # Setup Repo tool
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          
          # MANUAL INSTALL OF BINARIES
          echo "Setting up Android Image Tools..."
          
          mkdir -p tools
          cd tools
          
          # 1. Payload Dumper Go (Safe Extract)
          echo "Installing Payload Dumper..."
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          find . -type f -name "payload-dumper-go" -exec chmod +x {} \;
          find . -type f -name "payload-dumper-go" -exec mv {} . \; || true
          
          # 2. Compile simg2img / img2simg (Most robust method)
          echo "Compiling simg2img/img2simg from source..."
          git clone https://github.com/anestisb/android-simg2img
          cd android-simg2img
          make
          sudo cp simg2img /usr/local/bin/
          sudo cp img2simg /usr/local/bin/
          cd ..
          rm -rf android-simg2img
          
          # 3. Apktool
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.1.jar -O apktool.jar
          echo '#!/bin/bash' > apktool
          echo 'java -jar $(dirname $0)/apktool.jar "$@"' >> apktool
          chmod +x apktool
          
          # 4. Baksmali/Smali
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.5.2.jar -O baksmali.jar
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/smali-2.5.2.jar -O smali.jar
          echo "::endgroup::"

      - name: 3. Download & Extract Firmware
        working-directory: ./
        run: |
          set -e
          mkdir -p build/input
          mkdir -p build/output
          cd build/input
          
          echo "Downloading Firmware..."
          wget "${{ inputs.source_url }}" -O firmware.zip
          
          echo "Extracting..."
          7z l firmware.zip > content.txt
          mkdir -p raw_images
          
          if grep -q "payload.bin" content.txt; then
            echo "Format: Payload.bin"
            unzip firmware.zip payload.bin
            PD_TOOL="../../tools/payload-dumper-go"
            if [ ! -f "$PD_TOOL" ]; then
              PD_TOOL=$(find ../../tools -name payload-dumper-go -type f | head -n 1)
            fi
            "$PD_TOOL" -o raw_images -p system,system_ext,product,vendor,odm payload.bin
          elif grep -q "super.img" content.txt; then
            echo "Format: Super.img"
            unzip firmware.zip super.img
            simg2img super.img super.raw
            echo "::warning::Super.img extraction assumes flat image."
          else
            echo "Format: Standard Images"
            unzip firmware.zip "*.img" -d raw_images
          fi
          
          # Ensure images are raw
          cd raw_images
          for img in *.img; do
            if [ -f "$img" ]; then
                if file "$img" | grep -q "sparse"; then
                  echo "Converting sparse $img..."
                  simg2img "$img" "${img%.*}.raw"
                  mv "${img%.*}.raw" "$img"
                fi
            fi
          done

      - name: 4. Download Device Trees
        working-directory: ./build
        run: |
          set -e
          echo "Cloning Miatoll Source..."
          git clone "${{ inputs.device_tree_url }}" device/xiaomi/miatoll
          git clone "${{ inputs.vendor_tree_url }}" vendor/xiaomi/miatoll
          git clone "${{ inputs.kernel_tree_url }}" kernel/xiaomi/miatoll

      - name: 5. Prepare Images (Simple Rsync Loop)
        working-directory: ./build
        run: |
          set -e
          echo "::group::Preparing Images"
          
          mkdir -p port_rom/system port_rom/system_ext port_rom/product port_rom/vendor
          mkdir -p temp_mount_src
          
          process_partition() {
            PART=$1
            IMG="input/raw_images/$PART.img"
            MNT="port_rom/$PART"
            
            if [ -f "$IMG" ]; then
              echo "Processing $PART..."
              FS_TYPE=$(file -bL "$IMG" | awk '{print $1}')
              echo "Filesystem: $FS_TYPE"
              
              if [[ "$FS_TYPE" == "EROFS" ]] || [[ "$FS_TYPE" == "Linux" ]]; then
                 echo "EROFS detected. Converting to EXT4..."
                 
                 # 1. Create Target EXT4 Image (+1.5GB buffer for edits)
                 ORIG_SIZE=$(stat -c%s "$IMG")
                 NEW_SIZE=$(($ORIG_SIZE + 1610612736))
                 dd if=/dev/zero of="${PART}_ext4.img" bs=1 count=0 seek=$NEW_SIZE
                 mkfs.ext4 -F "${PART}_ext4.img"
                 
                 # 2. Mount Source (EROFS)
                 sudo mount -o loop,ro "$IMG" temp_mount_src
                 
                 # 3. Mount Target (EXT4)
                 sudo mount -o loop,rw "${PART}_ext4.img" "$MNT"
                 
                 # 4. SAFE COPY LOOP (No OOM, Permissions Handled)
                 echo "Starting Safe Copy..."
                 cd temp_mount_src
                 
                 # Loop through top-level items to avoid reading full tree into RAM
                 for ITEM in *; do
                   if [ -e "$ITEM" ]; then
                     echo "--> Copying $ITEM..."
                     # Use rsync for reliability. 
                     # -a: archive (perms, symlinks)
                     # --info=progress2: show progress
                     # --no-inc-recursive: save RAM on huge file lists
                     sudo rsync -a --no-inc-recursive "$ITEM" "../$MNT/"
                     
                     # Force flush RAM to disk
                     sudo sync
                   fi
                 done
                 cd ..
                 
                 # 5. Verify Content
                 SIZE_CHECK=$(sudo du -sh "$MNT" | cut -f1)
                 echo "Copied size: $SIZE_CHECK"
                 
                 # 6. Cleanup
                 sudo umount temp_mount_src
                 sudo umount "$MNT"
                 
                 # 7. Swap
                 rm "$IMG"
                 mv "${PART}_ext4.img" "$IMG"
                 
                 # 8. Remount
                 sudo mount -o loop,rw "$IMG" "$MNT"
                 
              else
                 echo "EXT4 detected. Resizing..."
                 dd if=/dev/zero bs=1M count=512 >> "$IMG"
                 e2fsck -f -y "$IMG" || true
                 resize2fs "$IMG"
                 sudo mount -o loop,rw "$IMG" "$MNT"
              fi
              
              # FINAL CHECK: If mount is empty, FAIL IMMEDIATELY
              USED_SPACE=$(sudo du -s "$MNT" | awk '{print $1}')
              # 50000 blocks ~ 50MB. System should be > 500MB usually.
              if [ "$USED_SPACE" -lt 50000 ]; then
                 echo "::error::Partition $PART seems empty ($USED_SPACE blocks). Copy failed!"
                 exit 1
              fi
            fi
          }
          
          process_partition system
          process_partition system_ext
          process_partition product
          process_partition vendor
          
          rm -rf temp_mount_src
          
          echo "Images mounted RW."
          echo "::endgroup::"

      - name: 6. Debloat System
        working-directory: ./build/port_rom
        run: |
          set -e
          echo "::group::Debloating"
          # Operations happen directly on the mounted image using SUDO
          APPS_TO_REMOVE="
          system/app/AnalyticsCore
          system/app/FacebookAppManager
          system/app/FacebookServices
          system/priv-app/AmazonShopping
          system/priv-app/NetflixStub
          product/app/YouTube
          product/app/YouTubeMusic
          product/app/Duo
          product/app/Gmail2
          system_ext/app/CarrierServices
          "
          
          for APP in $APPS_TO_REMOVE; do
             if sudo test -d "$APP"; then
               echo "Removing $APP"
               sudo rm -rf "$APP"
             fi
          done
          echo "::endgroup::"

      - name: 7. Apply Miatoll Adaptations
        working-directory: ./build
        run: |
          set -e
          echo "::group::Adapting for Miatoll"
          
          PORT="port_rom"
          DT="device/xiaomi/miatoll"
          
          # 1. Install Overlays (Sudo)
          sudo mkdir -p $PORT/product/overlay
          [ -d "$DT/overlay" ] && sudo cp -r "$DT/overlay/"* $PORT/product/overlay/
          
          # 2. Patch build.prop (Sudo Find & Sed)
          echo "Patching props..."
          sudo find $PORT -name "build.prop" | while read prop; do
            echo "Patching $prop"
            sudo sed -i 's/^ro.product.device=.*/ro.product.device=miatoll/' "$prop"
            sudo sed -i 's/^ro.product.board=.*/ro.product.board=sm6250/' "$prop"
            sudo sed -i 's/^ro.adb.secure=.*/ro.adb.secure=0/' "$prop"
          done
          
          # 3. Audio Configs (Sudo)
          if sudo test -d "$PORT/vendor/etc"; then
            [ -f "$DT/audio/audio_policy_configuration.xml" ] && sudo cp "$DT/audio/audio_policy_configuration.xml" "$PORT/vendor/etc/"
          fi
          
          echo "::endgroup::"

      - name: 8. Smali Patching (Services.jar)
        working-directory: ./build
        run: |
          set -e
          echo "::group::Smali Patching"
          TOOLS="../tools"
          
          # Find services.jar recursively via sudo
          JAR_PATH=$(sudo find port_rom -name "services.jar" | grep "framework" | head -n 1)
          
          if [ ! -z "$JAR_PATH" ]; then
            echo "Found services.jar at: $JAR_PATH"
            
            # Copy OUT
            sudo cp "$JAR_PATH" services.jar
            sudo chmod 666 services.jar
            
            echo "Decompiling services.jar..."
            java -jar $TOOLS/baksmali.jar d services.jar -o services_out
            
            # Simple patch example
            echo "Applying mocked patches..."
            
            echo "Recompiling..."
            java -jar $TOOLS/smali.jar a services_out -o classes.dex
            
            # Update the jar
            zip -u services.jar classes.dex
            
            # Copy IN
            sudo cp services.jar "$JAR_PATH"
            
            # Cleanup
            rm -rf services_out classes.dex services.jar
          else
            echo "::warning::services.jar not found via find command."
          fi
          echo "::endgroup::"

      - name: 9. Build Final Images
        working-directory: ./build
        run: |
          set -e
          echo "::group::Building Images"
          # Correct output directory
          OUT_DIR="output"
          mkdir -p $OUT_DIR
          sudo chmod 777 $OUT_DIR
          
          finalize_image() {
            PART=$1
            MNT="port_rom/$PART"
            IMG="input/raw_images/$PART.img"
            
            if [ -d "$MNT" ] && [ -f "$IMG" ]; then
               echo "Finalizing $PART..."
               
               # 1. Unmount the RW image
               sudo umount "$MNT"
               
               # 2. Shrink/Optimize
               sudo e2fsck -f -y "$IMG" || true
               sudo resize2fs -M "$IMG"
               
               # 3. Convert to sparse
               echo "Converting to sparse..."
               sudo img2simg "$IMG" "$OUT_DIR/$PART.img"
            fi
          }
          
          finalize_image system
          finalize_image system_ext
          finalize_image product
          finalize_image vendor
          
          echo "::endgroup::"

      - name: 10. Create Output Artifact
        working-directory: ./build/output
        run: |
          set -e
          echo "Fixing permissions..."
          sudo chown -R $USER:$USER .
          ls -lh
          
          if [ "${{ inputs.output_format }}" == "recovery_zip" ]; then
            echo "Zipping images..."
            zip -r miatoll_port.zip *.img
            rm *.img
          fi

      - name: 11. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Miatoll_Port_${{ inputs.rom_type }}_${{ inputs.android_version }}
          path: build/output/*
