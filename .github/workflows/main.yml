name: Miatoll Auto-Porter (SM6250)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'Direct URL to Source ROM (Fastboot/Recovery Zip/Payload)'
        required: true
        type: string
      rom_type:
        description: 'Source ROM Type'
        required: true
        type: choice
        options:
          - AOSP
          - MIUI
          - OneUI
          - OxygenOS
          - ColorOS
          - Other
      android_version:
        description: 'Android Version'
        required: true
        default: '13'
        type: string
      device_tree_url:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/LineageOS/android_device_xiaomi_miatoll'
        type: string
      vendor_tree_url:
        description: 'Vendor Tree URL'
        required: true
        default: 'https://github.com/clarencelol/vendor_xiaomi_miatoll'
        type: string
      kernel_tree_url:
        description: 'Kernel Tree URL'
        required: true
        default: 'https://github.com/LineageOS/android_kernel_xiaomi_sm6250'
        type: string
      target_variant:
        description: 'Target Region'
        required: true
        type: choice
        options:
          - global
          - india
          - china
      output_format:
        description: 'Output Format'
        required: true
        type: choice
        options:
          - recovery_zip
          - super_img

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: 1. Environment Cleanup (Aggressive)
        id: cleanup
        run: |
          set -e
          echo "::group::Cleaning Disk Space"
          df -h
          
          # Remove massive pre-installed packages
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/lib/google-cloud-sdk
          sudo rm -rf /usr/lib/jvm
          
          # Clean Docker and APT
          sudo docker system prune -a -f
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo rm -rf /var/lib/apt/lists/*
          
          # Check space (Threshold 30GB)
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "Free Space: ${AVAILABLE}GB"
          if [ "$AVAILABLE" -lt 30 ]; then
            echo "::error::Not enough disk space (<30GB). Setup failed."
            exit 1
          fi
          
          # Setup Swap (12GB)
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "::endgroup::"

      - name: 2. Install Tools & Dependencies
        run: |
          set -e
          echo "::group::Installing Packages"
          sudo apt-get update
          
          # Install deps including zlib for compiling simg2img
          sudo apt-get install -y \
            git wget curl python3 python3-pip zip unzip tar 7zip \
            brotli lz4 openjdk-17-jdk \
            liblz4-tool e2fsprogs device-tree-compiler build-essential zlib1g-dev
          
          # Install Python protobuf
          pip3 install --upgrade pip protobuf
          
          # Setup Repo tool
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          
          # MANUAL INSTALL OF BINARIES
          echo "Setting up Android Image Tools..."
          
          mkdir -p tools
          cd tools
          
          # 1. Payload Dumper Go (Safe Extract)
          echo "Installing Payload Dumper..."
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          # Robust find to locate binary
          find . -type f -name "payload-dumper-go" -exec chmod +x {} \;
          find . -type f -name "payload-dumper-go" -exec mv {} . \; || true
          
          # 2. Compile simg2img / img2simg (Most robust method)
          echo "Compiling simg2img/img2simg from source..."
          git clone https://github.com/anestisb/android-simg2img
          cd android-simg2img
          make
          sudo cp simg2img /usr/local/bin/
          sudo cp img2simg /usr/local/bin/
          cd ..
          rm -rf android-simg2img
          
          # 3. Apktool
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.1.jar -O apktool.jar
          echo '#!/bin/bash' > apktool
          echo 'java -jar $(dirname $0)/apktool.jar "$@"' >> apktool
          chmod +x apktool
          
          # 4. Baksmali/Smali
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.5.2.jar -O baksmali.jar
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/smali-2.5.2.jar -O smali.jar
          echo "::endgroup::"

      - name: 3. Download & Extract Firmware
        working-directory: ./
        run: |
          set -e
          mkdir -p build/input
          mkdir -p build/output
          cd build/input
          
          echo "Downloading Firmware..."
          wget "${{ inputs.source_url }}" -O firmware.zip
          
          echo "Extracting..."
          7z l firmware.zip > content.txt
          mkdir -p raw_images
          
          if grep -q "payload.bin" content.txt; then
            echo "Format: Payload.bin"
            unzip firmware.zip payload.bin
            # Call payload-dumper-go (it might be in root or a subdir, usually root now)
            PD_TOOL="../../tools/payload-dumper-go"
            if [ ! -f "$PD_TOOL" ]; then
              # Fallback search
              PD_TOOL=$(find ../../tools -name payload-dumper-go -type f | head -n 1)
            fi
            "$PD_TOOL" -o raw_images -p system,system_ext,product,vendor,odm payload.bin
          elif grep -q "super.img" content.txt; then
            echo "Format: Super.img"
            unzip firmware.zip super.img
            simg2img super.img super.raw
            echo "::warning::Super.img extraction assumes flat image."
          else
            echo "Format: Standard Images"
            unzip firmware.zip "*.img" -d raw_images
          fi
          
          # Ensure images are raw
          cd raw_images
          for img in *.img; do
            if [ -f "$img" ]; then
                if file "$img" | grep -q "sparse"; then
                  echo "Converting sparse $img..."
                  simg2img "$img" "${img%.*}.raw"
                  mv "${img%.*}.raw" "$img"
                fi
            fi
          done

      - name: 4. Download Device Trees
        working-directory: ./build
        run: |
          set -e
          echo "Cloning Miatoll Source..."
          
          # Using verified active repos to avoid 404/auth errors
          echo "Cloning Device Tree..."
          git clone "${{ inputs.device_tree_url }}" device/xiaomi/miatoll
          
          echo "Cloning Vendor Tree..."
          git clone "${{ inputs.vendor_tree_url }}" vendor/xiaomi/miatoll
          
          echo "Cloning Kernel Tree..."
          git clone "${{ inputs.kernel_tree_url }}" kernel/xiaomi/miatoll

      - name: 5. Mount & Prepare Filesystem
        working-directory: ./build
        run: |
          set -e
          echo "Mounting Images..."
          mkdir -p mnt/system mnt/system_ext mnt/product mnt/vendor
          mkdir -p port_rom/system port_rom/system_ext port_rom/product port_rom/vendor
          
          mount_and_copy() {
            PART=$1
            IMG="input/raw_images/$PART.img"
            MNT="mnt/$PART"
            DEST="port_rom/$PART"
            
            if [ -f "$IMG" ]; then
              # Try mounting ext4
              if sudo mount -o loop,ro "$IMG" "$MNT"; then
                echo "Mounted $PART"
                sudo cp -a "$MNT/." "$DEST/"
                sudo umount "$MNT"
              else
                echo "Mount failed for $PART (possibly EROFS), trying 7z extract..."
                7z x "$IMG" -o"$DEST" || true
              fi
            fi
          }
          
          mount_and_copy system
          mount_and_copy system_ext
          mount_and_copy product
          mount_and_copy vendor

      - name: 6. Debloat System
        working-directory: ./build/port_rom
        run: |
          set -e
          echo "::group::Debloating"
          # List of heavy/unnecessary apps
          APPS_TO_REMOVE="
          system/app/AnalyticsCore
          system/app/FacebookAppManager
          system/app/FacebookServices
          system/priv-app/AmazonShopping
          system/priv-app/NetflixStub
          product/app/YouTube
          product/app/YouTubeMusic
          product/app/Duo
          product/app/Gmail2
          system_ext/app/CarrierServices
          "
          
          for APP in $APPS_TO_REMOVE; do
            if [ -d "$APP" ]; then
              echo "Removing $APP"
              sudo rm -rf "$APP"
            fi
          done
          echo "::endgroup::"

      - name: 7. Apply Miatoll Adaptations
        working-directory: ./build
        run: |
          set -e
          echo "::group::Adapting for Miatoll"
          
          PORT="port_rom"
          DT="device/xiaomi/miatoll"
          
          # 1. Install Overlays
          sudo mkdir -p $PORT/product/overlay
          [ -d "$DT/overlay" ] && sudo cp -r "$DT/overlay/"* $PORT/product/overlay/
          
          # 2. Patch build.prop
          echo "Patching props..."
          find $PORT -name "build.prop" | while read prop; do
            sudo sed -i 's/^ro.product.device=.*/ro.product.device=miatoll/' "$prop"
            sudo sed -i 's/^ro.product.board=.*/ro.product.board=sm6250/' "$prop"
            sudo sed -i 's/^ro.adb.secure=.*/ro.adb.secure=0/' "$prop"
          done
          
          # 3. Audio Configs
          if [ -d "$PORT/vendor/etc" ]; then
            [ -f "$DT/audio/audio_policy_configuration.xml" ] && sudo cp "$DT/audio/audio_policy_configuration.xml" "$PORT/vendor/etc/"
          fi
          
          echo "::endgroup::"

      - name: 8. Smali Patching (Services.jar)
        working-directory: ./build
        run: |
          set -e
          echo "::group::Smali Patching"
          TOOLS="../tools"
          JAR="$PWD/port_rom/system/framework/services.jar"
          
          if [ -f "$JAR" ]; then
            echo "Decompiling services.jar..."
            java -jar $TOOLS/baksmali.jar d "$JAR" -o services_out
            
            # Simple patch example: Disable signature verification mock
            # Real world: Apply .diff patches or sed on smali files
            echo "Applying mocked patches..."
            
            echo "Recompiling..."
            java -jar $TOOLS/smali.jar a services_out -o classes.dex
            zip -u "$JAR" classes.dex
            rm -rf services_out classes.dex
          else
            echo "services.jar not found."
          fi
          echo "::endgroup::"

      - name: 9. Build Final Images
        working-directory: ./build
        run: |
          set -e
          echo "::group::Building Images"
          OUT_DIR="../output"
          mkdir -p $OUT_DIR
          
          repack_image() {
            NAME=$1
            SRC="port_rom/$NAME"
            if [ -d "$SRC" ]; then
              # Calculate size + 150MB buffer
              SIZE=$(du -sb "$SRC" | cut -f1)
              SIZE=$(($SIZE + 157286400))
              
              echo "Repacking $NAME.img ($SIZE bytes)..."
              # Create empty file
              dd if=/dev/zero of="$NAME.img" bs=1 count=0 seek=$SIZE
              # Format ext4
              mkfs.ext4 -L $NAME "$NAME.img"
              # Copy files
              mkdir -p tmp_mnt
              sudo mount -o loop "$NAME.img" tmp_mnt
              sudo cp -a "$SRC/." tmp_mnt/
              sudo umount tmp_mnt
              rm -rf tmp_mnt
              
              # Convert to sparse
              img2simg "$NAME.img" "$OUT_DIR/$NAME.img"
              rm "$NAME.img"
            fi
          }
          
          repack_image system
          repack_image system_ext
          repack_image product
          repack_image vendor
          
          echo "::endgroup::"

      - name: 10. Create Output Artifact
        working-directory: ./build/output
        run: |
          set -e
          if [ "${{ inputs.output_format }}" == "recovery_zip" ]; then
            echo "Zipping images..."
            zip -r miatoll_port.zip *.img
            rm *.img
          fi

      - name: 11. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Miatoll_Port_${{ inputs.rom_type }}_${{ inputs.android_version }}
          path: build/output/*
