name: Miatoll Auto-Porter (SM6250)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'Direct URL to Source ROM (Fastboot/Recovery Zip/Payload)'
        required: true
        type: string
      rom_type:
        description: 'Source ROM Type'
        required: true
        type: choice
        options:
          - AOSP
          - MIUI
          - OneUI
          - OxygenOS
          - ColorOS
          - Other
      android_version:
        description: 'Android Version'
        required: true
        default: '13'
        type: string
      device_tree_url:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/LineageOS/android_device_xiaomi_miatoll'
        type: string
      vendor_tree_url:
        description: 'Vendor Tree URL'
        required: true
        default: 'https://github.com/clarencelol/vendor_xiaomi_miatoll'
        type: string
      kernel_tree_url:
        description: 'Kernel Tree URL'
        required: true
        default: 'https://github.com/LineageOS/android_kernel_xiaomi_sm6250'
        type: string
      target_variant:
        description: 'Target Region'
        required: true
        type: choice
        options:
          - global
          - india
          - china
      output_format:
        description: 'Output Format'
        required: true
        type: choice
        options:
          - recovery_zip
          - super_img

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: 1. Environment Cleanup (Aggressive)
        id: cleanup
        run: |
          set -e
          echo "::group::Cleaning Disk Space"
          df -h
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/lib/google-cloud-sdk
          sudo rm -rf /usr/lib/jvm
          sudo docker system prune -a -f
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo rm -rf /var/lib/apt/lists/*
          AVAILABLE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          if [ "$AVAILABLE" -lt 30 ]; then echo "::error::Space < 30GB"; exit 1; fi
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo dd if=/dev/zero of=/swapfile bs=1M count=12288 status=progress
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "::endgroup::"

      - name: 2. Install Tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y git wget curl python3 python3-pip zip unzip tar 7zip \
            brotli lz4 openjdk-17-jdk liblz4-tool e2fsprogs device-tree-compiler \
            build-essential zlib1g-dev erofs-utils
          pip3 install --upgrade pip protobuf
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          mkdir -p tools
          cd tools
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          find . -type f -name "payload-dumper-go" -exec chmod +x {} \;
          find . -type f -name "payload-dumper-go" -exec mv {} . \; || true
          git clone https://github.com/anestisb/android-simg2img
          cd android-simg2img
          make
          sudo cp simg2img /usr/local/bin/
          sudo cp img2simg /usr/local/bin/
          cd ..
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.1.jar -O apktool.jar
          echo '#!/bin/bash' > apktool && echo 'java -jar $(dirname $0)/apktool.jar "$@"' >> apktool && chmod +x apktool
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.5.2.jar -O baksmali.jar
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/smali-2.5.2.jar -O smali.jar

      - name: 3. Download & Extract Firmware
        working-directory: ./
        run: |
          set -e
          mkdir -p build/input
          mkdir -p build/output
          cd build/input
          echo "Downloading..."
          wget "${{ inputs.source_url }}" -O firmware.zip
          7z l firmware.zip > content.txt
          mkdir -p raw_images
          if grep -q "payload.bin" content.txt; then
            unzip firmware.zip payload.bin
            PD_TOOL="../../tools/payload-dumper-go"
            [ ! -f "$PD_TOOL" ] && PD_TOOL=$(find ../../tools -name payload-dumper-go -type f | head -n 1)
            "$PD_TOOL" -o raw_images -p system,system_ext,product,vendor,odm payload.bin
          elif grep -q "super.img" content.txt; then
            unzip firmware.zip super.img
            simg2img super.img super.raw
          else
            unzip firmware.zip "*.img" -d raw_images
          fi
          cd raw_images
          for img in *.img; do
            if [ -f "$img" ]; then
                if file "$img" | grep -q "sparse"; then simg2img "$img" "${img%.*}.raw"; mv "${img%.*}.raw" "$img"; fi
            fi
          done

      - name: 4. Clone Trees
        working-directory: ./build
        run: |
          set -e
          git clone "${{ inputs.device_tree_url }}" device/xiaomi/miatoll
          git clone "${{ inputs.vendor_tree_url }}" vendor/xiaomi/miatoll
          git clone "${{ inputs.kernel_tree_url }}" kernel/xiaomi/miatoll

      - name: 5. Prepare Images (Controlled Python Copy)
        working-directory: ./build
        run: |
          set -e
          echo "::group::Preparing Images"
          
          # Create robust Python copy script
          cat << 'EOF' > safe_copy.py
          import os
          import subprocess
          import sys

          src_root = sys.argv[1]
          dst_root = sys.argv[2]
          byte_counter = 0
          # Sync every 50MB
          SYNC_LIMIT = 50 * 1024 * 1024 

          print(f"Python Copy: {src_root} -> {dst_root}")

          for root, dirs, files in os.walk(src_root):
              rel_path = os.path.relpath(root, src_root)
              dest_dir = os.path.join(dst_root, rel_path)
              if not os.path.exists(dest_dir):
                  os.makedirs(dest_dir, exist_ok=True)

              for name in files:
                  s = os.path.join(root, name)
                  d = os.path.join(dest_dir, name)
                  
                  # Skip symlinks for size check, but copy them
                  if not os.path.islink(s):
                      byte_counter += os.path.getsize(s)
                  
                  # cp -a preserves everything (links, contexts)
                  subprocess.run(["cp", "-a", s, d], check=True)
                  
                  if byte_counter >= SYNC_LIMIT:
                      subprocess.run(["sync"])
                      byte_counter = 0

          subprocess.run(["sync"])
          print("Copy finished successfully.")
          EOF

          mkdir -p port_rom/system port_rom/system_ext port_rom/product port_rom/vendor
          mkdir -p temp_mount_src
          
          process_partition() {
            PART=$1
            IMG_PATH="$(pwd)/input/raw_images/$PART.img"
            MNT_PATH="$(pwd)/port_rom/$PART"
            SRC_MNT="$(pwd)/temp_mount_src"
            
            if [ -f "$IMG_PATH" ]; then
              echo "Processing $PART..."
              FS_TYPE=$(file -bL "$IMG_PATH" | awk '{print $1}')
              
              if [[ "$FS_TYPE" == "EROFS" ]] || [[ "$FS_TYPE" == "Linux" ]]; then
                 echo "EROFS detected. Converting..."
                 
                 # Calc size: Original * 3 + 2GB (Safe buffer for extraction)
                 ORIG_SIZE=$(stat -c%s "$IMG_PATH")
                 NEW_SIZE=$(($ORIG_SIZE * 3 + 2147483648))
                 
                 dd if=/dev/zero of="${PART}_ext4.img" bs=1 count=0 seek=$NEW_SIZE
                 mkfs.ext4 -F "${PART}_ext4.img"
                 
                 sudo mount -o loop,ro "$IMG_PATH" "$SRC_MNT"
                 sudo mount -o loop,rw "${PART}_ext4.img" "$MNT_PATH"
                 
                 echo "Running Python Copy..."
                 sudo python3 safe_copy.py "$SRC_MNT" "$MNT_PATH"
                 
                 sudo umount "$SRC_MNT"
                 sudo umount "$MNT_PATH"
                 
                 rm "$IMG_PATH"
                 mv "${PART}_ext4.img" "$IMG_PATH"
                 sudo mount -o loop,rw "$IMG_PATH" "$MNT_PATH"
              else
                 echo "EXT4 detected. Resizing..."
                 dd if=/dev/zero bs=1M count=2048 >> "$IMG_PATH"
                 e2fsck -f -y "$IMG_PATH" || true
                 resize2fs "$IMG_PATH"
                 sudo mount -o loop,rw "$IMG_PATH" "$MNT_PATH"
              fi
              
              # Sanity Check
              USED=$(sudo du -s "$MNT_PATH" | awk '{print $1}')
              if [ "$USED" -lt 1000 ]; then echo "::error::Empty partition $PART"; exit 1; fi
            fi
          }
          
          process_partition system
          process_partition system_ext
          process_partition product
          process_partition vendor
          
          rm -rf temp_mount_src safe_copy.py
          echo "::endgroup::"

      - name: 6. Debloat
        working-directory: ./build/port_rom
        run: |
          set -e
          APPS="
          system/app/AnalyticsCore system/app/FacebookAppManager system/app/FacebookServices
          system/priv-app/AmazonShopping system/priv-app/NetflixStub
          product/app/YouTube product/app/YouTubeMusic product/app/Duo product/app/Gmail2
          system_ext/app/CarrierServices
          "
          for APP in $APPS; do
             if sudo test -d "$APP"; then sudo rm -rf "$APP"; fi
          done

      - name: 7. Miatoll Patching
        working-directory: ./build
        run: |
          set -e
          PORT="port_rom"
          DT="device/xiaomi/miatoll"
          sudo mkdir -p $PORT/product/overlay
          [ -d "$DT/overlay" ] && sudo cp -r "$DT/overlay/"* $PORT/product/overlay/
          sudo find $PORT -name "build.prop" | while read prop; do
            sudo sed -i 's/^ro.product.device=.*/ro.product.device=miatoll/' "$prop"
            sudo sed -i 's/^ro.product.board=.*/ro.product.board=sm6250/' "$prop"
            sudo sed -i 's/^ro.adb.secure=.*/ro.adb.secure=0/' "$prop"
          done
          if sudo test -d "$PORT/vendor/etc"; then
            [ -f "$DT/audio/audio_policy_configuration.xml" ] && sudo cp "$DT/audio/audio_policy_configuration.xml" "$PORT/vendor/etc/"
          fi

      - name: 8. Smali Patching
        working-directory: ./build
        run: |
          set -e
          TOOLS="../tools"
          JAR_PATH=$(sudo find port_rom -name "services.jar" | grep "framework" | head -n 1)
          if [ ! -z "$JAR_PATH" ]; then
            sudo cp "$JAR_PATH" services.jar && sudo chmod 666 services.jar
            java -jar $TOOLS/baksmali.jar d services.jar -o services_out
            # Optional patch logic here
            java -jar $TOOLS/smali.jar a services_out -o classes.dex
            zip -u services.jar classes.dex
            sudo cp services.jar "$JAR_PATH"
            rm -rf services_out classes.dex services.jar
          fi

      - name: 9. Finalize Images
        working-directory: ./build
        run: |
          set -e
          OUT_DIR="output"
          mkdir -p $OUT_DIR
          sudo chmod 777 $OUT_DIR
          
          finalize() {
            PART=$1
            MNT="$(pwd)/port_rom/$PART"
            IMG="$(pwd)/input/raw_images/$PART.img"
            if [ -d "$MNT" ] && [ -f "$IMG" ]; then
               sudo umount "$MNT"
               sudo e2fsck -f -y "$IMG" || true
               sudo resize2fs -M "$IMG"
               sudo img2simg "$IMG" "$OUT_DIR/$PART.img"
            fi
          }
          finalize system
          finalize system_ext
          finalize product
          finalize vendor

      - name: 10. Artifacts
        working-directory: ./build/output
        run: |
          set -e
          sudo chown -R $USER:$USER .
          if [ "${{ inputs.output_format }}" == "recovery_zip" ]; then
            zip -r miatoll_port.zip *.img
            rm *.img
          fi

      - name: 11. Upload
        uses: actions/upload-artifact@v4
        with:
          name: Miatoll_Port
          path: build/output/*
